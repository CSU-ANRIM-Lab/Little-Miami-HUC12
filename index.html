<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/L.Control.Locate.min.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet-search.css">
    <link rel="stylesheet" href="css/leaflet-control-geocoder.Geocoder.css">
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>
    <title>Map with HUC12 Search</title>
</head>
<body>
    <div id="map"></div>
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/L.Control.Locate.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
    <script src="js/proj4.js"></script>
    <script src="js/proj4leaflet.js"></script>
    <script src="js/leaflet-search.js"></script>
    <script src="data/WBD_HU12_0.js"></script>
    <script src="data/WBD_HU8_1.js"></script>
    <script>
        var crs = new L.Proj.CRS('ESRI:102003', '+proj=aea +lat_0=37.5 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0.9956,-1.9013,-0.5215,-0.025915,-0.009426,-0.011599,0.00062 +units=m +no_defs', {
            resolutions: [2800, 1400, 700, 350, 175, 84, 42, 21, 11.2, 5.6, 2.8, 1.4, 0.7, 0.35, 0.14, 0.07],
        });

        var map = L.map('map', {
            crs: crs,
            continuousWorld: false,
            worldCopyJump: false, 
            zoomControl: false, maxZoom: 28, minZoom: 1
        }).fitBounds([[38.33075117991867,-86.42193933921857],[41.22143687619394,-81.56652608256566]]);
        
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({ locateOptions: { maxZoom: 19 } }).addTo(map);
        
        var bounds_group = new L.featureGroup([]);

        function setBounds() {
            map.fitBounds(bounds_group.getBounds());
        }

        function pop_WBD_HU12_0(feature, layer) {
            var popupContent = '<table>\
                    <tr><td>HUC12:</td><td>' + (feature.properties['HUC12'] !== null ? autolinker.link(feature.properties['HUC12'].toLocaleString()) : '') + '</td></tr>\
                    <tr><td>Name:</td><td>' + (feature.properties['NAME'] !== null ? autolinker.link(feature.properties['NAME'].toLocaleString()) : '') + '</td></tr>\
                </table>';
            layer.bindPopup(popupContent, { maxHeight: 400 });
        }

        function style_WBD_HU12_0_0() {
            return {
                pane: 'pane_WBD_HU12_0',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(72,122,183,1.0)',
                interactive: true,
            }
        }

        map.createPane('pane_WBD_HU12_0');
        map.getPane('pane_WBD_HU12_0').style.zIndex = 400;
        map.getPane('pane_WBD_HU12_0').style['mix-blend-mode'] = 'normal';

        var layer_WBD_HU12_0 = new L.geoJson(json_WBD_HU12_0, {
            attribution: '',
            interactive: true,
            dataVar: 'json_WBD_HU12_0',
            layerName: 'layer_WBD_HU12_0',
            pane: 'pane_WBD_HU12_0',
            onEachFeature: pop_WBD_HU12_0,
            style: style_WBD_HU12_0_0,
        });

        bounds_group.addLayer(layer_WBD_HU12_0);
        map.addLayer(layer_WBD_HU12_0);

        // Adding the search control for HUC12
        var searchControl = new L.Control.Search({
            layer: layer_WBD_HU12_0,
            propertyName: 'HUC12',
            marker: false,
            moveToLocation: function(latlng, title, map) {
                map.setView(latlng, 14); // Zoom level when searching
            }
        });

        searchControl.on('search:locationfound', function(e) {
            if (e.layer._popup) e.layer.openPopup();
        }).on('search:collapsed', function(e) {
            map.eachLayer(function(layer) {
                layer.setStyle({ fillColor: 'rgba(72,122,183,1.0)' }); // Reset the fill color after search collapse
            });
        });

        map.addControl(searchControl);

        var osmGeocoder = new L.Control.Geocoder({
            collapsed: true,
            position: 'topleft',
            text: 'Search',
            title: 'Testing'
        }).addTo(map);

        document.getElementsByClassName('leaflet-control-geocoder-icon')[0].className += ' fa fa-search';
        document.getElementsByClassName('leaflet-control-geocoder-icon')[0].title += 'Search for a place';

        var baseMaps = {};
        var overlaysTree = [
            {label: '<img src="legend/WBD_HU8_1.png" /> WBD_HU8', layer: layer_WBD_HU8_1},
            {label: '<img src="legend/WBD_HU12_0.png" /> WBD_HU12', layer: layer_WBD_HU12_0},
        ];
        
        var lay = L.control.layers.tree(null, overlaysTree, {
            collapsed: false, 
        });
        lay.addTo(map);
        setBounds();
    </script>
</body>
</html>
